<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discourse Network Visualizer Pro</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --dark-bg: #2c3e50;
            --light-bg: #ecf0f1;
            --accent-color: #e74c3c;
            --text-light: #ffffff;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
            background-color: var(--light-bg);
        }

        /* Sidebar Styling */
        #left-panel {
            width: 300px;
            background: var(--dark-bg);
            color: var(--text-light);
            padding: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0,0,0,0.2);
            z-index: 10;
            overflow-y: auto;
        }

        #title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 5px;
            color: var(--primary-color);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #subtitle {
            font-size: 13px;
            margin-bottom: 20px;
            opacity: 0.8;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 10px;
        }

        .link-btn {
            font-size: 12px;
            color: var(--primary-color);
            text-decoration: none;
            cursor: pointer;
            margin-bottom: 10px;
            transition: color 0.3s;
        }

        .link-btn:hover {
            color: var(--secondary-color);
            text-decoration: underline;
        }

        /* Form Controls */
        #controls {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 10px;
        }

        #file-input {
            margin: 10px 0;
            font-size: 12px;
            color: #bdc3c7;
        }

        select, input[type="text"] {
            padding: 10px;
            border-radius: 5px;
            border: none;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 14px;
        }

        select option {
            background: var(--dark-bg);
        }

        button {
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            background: var(--primary-color);
            color: white;
        }

        button:hover:not(:disabled) {
            filter: brightness(1.2);
            transform: translateY(-1px);
        }

        button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        #save-csv-button { background: var(--secondary-color); }
        #save-graph-button { background: #9b59b6; }

        /* Graph Area */
        #graph-container {
            flex: 1;
            position: relative;
            background: #ffffff;
        }

        svg {
            width: 100%;
            height: 100%;
        }

        /* Network Elements */
        .node {
            stroke: #fff;
            stroke-width: 2px;
            cursor: pointer;
            transition: r 0.3s;
        }

        .edge {
            fill: none;
            stroke-opacity: 0.6;
            stroke-width: 2px;
            cursor: pointer;
        }

        .edge-highlight {
            stroke: #f1c40f;
            stroke-width: 5px;
            animation: blink 0.8s infinite;
        }

        @keyframes blink {
            50% { opacity: 0.4; }
        }

        .label {
            font-size: 11px;
            font-weight: 600;
            fill: #34495e;
            pointer-events: none;
            text-shadow: 0 1px 2px rgba(255,255,255,0.8);
        }

        /* Tooltip & Popups */
        .tooltip {
            position: absolute;
            background: rgba(44, 62, 80, 0.95);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            box-shadow: var(--shadow);
            max-width: 250px;
            z-index: 100;
        }

        .modal-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
            width: 450px;
            max-height: 80vh;
            display: none;
            z-index: 1000;
            overflow: hidden;
            border: 1px solid #ddd;
        }

        .popup-header {
            background: var(--dark-bg);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
        }

        .popup-content {
            padding: 20px;
            overflow-y: auto;
            max-height: calc(80vh - 60px);
            font-size: 14px;
            line-height: 1.6;
        }

        .close-btn { cursor: pointer; font-size: 20px; }
        .highlight { color: var(--accent-color); font-weight: bold; }
        
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-size: 11px;
            white-space: pre-wrap;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div id="left-panel">
        <div id="title">DNV PRO</div>
        <div id="subtitle">by Purnama Alamsyah @2026</div>
        
        <div id="citation-link" class="link-btn">üìå Cite this Software</div>
        <div id="prompt-link" class="link-btn">üìú Get GML Prompt</div>
        
        <input type="file" id="file-input" accept=".gml,.txt">
        
        <div id="controls">
            <select id="actor-select" disabled>
                <option value="">-- Select Actor --</option>
            </select>
            <select id="concept-select" disabled>
                <option value="">-- Select Concept --</option>
            </select>
            
            <div style="display: flex; flex-direction: column; gap: 5px;">
                <input type="text" id="search-input" placeholder="Search keywords..." disabled>
                <button id="search-button" disabled>üîç Search Network</button>
            </div>
            
            <div id="reference-filter-container" style="display:none; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 5px;">
                <div style="font-size: 12px; margin-bottom: 8px; color: var(--primary-color);">Filter References:</div>
                <div id="reference-checkboxes" style="font-size: 12px; max-height: 100px; overflow-y: auto;"></div>
                <button id="refresh-button" style="margin-top: 10px; width: 100%; font-size: 12px;">Update View</button>
            </div>
            
            <button id="save-csv-button" disabled>üìä Export Data (CSV)</button>
            <button id="save-graph-button" disabled>üñºÔ∏è Export Graph (PNG)</button>
        </div>
    </div>

    <div id="graph-container"></div>

    <div id="search-popup" class="modal-popup">
        <div class="popup-header"><span>Search Results</span><span class="close-btn" onclick="closePopup('search-popup')">√ó</span></div>
        <div id="search-results" class="popup-content"></div>
    </div>

    <div id="citation-popup" class="modal-popup">
        <div class="popup-header"><span>BibTeX Citation</span><span class="close-btn" onclick="closePopup('citation-popup')">√ó</span></div>
        <div class="popup-content">
            <pre>@software{alamsyah2026DNV,
  author       = {Alamsyah, Purnama},
  title        = {{Discourse Network Visualizer Pro} (Version 1.0)},
  year         = {2026},
  publisher    = {Independent Research},
  address      = {Indonesia}
}</pre>
        </div>
    </div>

    <div id="node-statements-popup" class="modal-popup">
        <div class="popup-header"><span id="node-title">Statements</span><span class="close-btn" onclick="closePopup('node-statements-popup')">√ó</span></div>
        <div id="node-statements-results" class="popup-content"></div>
    </div>

    <div id="edge-details-popup" class="modal-popup">
        <div class="popup-header"><span>Connection Details</span><span class="close-btn" onclick="closePopup('edge-details-popup')">√ó</span></div>
        <div id="edge-details-content" class="popup-content"></div>
    </div>

    <div id="prompt-popup" class="modal-popup">
        <div class="popup-header"><span>GML Prompt Template</span><span class="close-btn" onclick="closePopup('prompt-popup')">√ó</span></div>
        <div class="popup-content">
            <pre>Extract data in GML format with the following structure:
Nodes: 
- id (unique int)
- type ("Actor" or "Concept")
- label (Name/Category)
- description (Organization for Actor)

Edges:
- source (Actor ID)
- target (Concept ID)
- statement (Original text)
- agreement ("Yes"/"No")
- reference (Source doc)</pre>
        </div>
    </div>

    <script>
        // Global State
        let width = window.innerWidth - 300;
        let height = window.innerHeight;
        let originalData = { nodes: [], edges: [], references: [] };
        let data = { nodes: [], edges: [] };
        let currentTransform = d3.zoomIdentity;

        // Init SVG
        const svg = d3.select("#graph-container").append("svg")
            .attr("width", width)
            .attr("height", height);

        const g = svg.append("g");

        const zoom = d3.zoom()
            .scaleExtent([0.1, 5])
            .on("zoom", (event) => {
                currentTransform = event.transform;
                g.attr("transform", currentTransform);
            });

        svg.call(zoom);

        const tooltip = d3.select("body").append("div").attr("class", "tooltip").style("opacity", 0);

        // --- Functions ---

        function closePopup(id) {
            d3.select("#" + id).style("display", "none");
        }

        function parseGML(text) {
            const nodes = [], edges = [], refs = new Set();
            let currentNode = null, currentEdge = null;
            let inNode = false, inEdge = false;

            text.split('\n').forEach(line => {
                line = line.trim();
                if (line.startsWith("node [")) { inNode = true; currentNode = {}; }
                else if (line.startsWith("edge [")) { inEdge = true; currentEdge = {}; }
                else if (line === "]") {
                    if (inNode) { nodes.push(currentNode); inNode = false; }
                    else if (inEdge) { 
                        edges.push(currentEdge); 
                        if(currentEdge.reference) refs.add(currentEdge.reference);
                        inEdge = false; 
                    }
                } else {
                    const match = line.match(/(\w+)\s+"?([^"]*)"?/);
                    if (match) {
                        const key = match[1], val = match[2];
                        if (inNode) currentNode[key] = val;
                        else if (inEdge) currentEdge[key] = val;
                    }
                }
            });

            edges.forEach(e => {
                e.source = nodes.find(n => n.id === e.source);
                e.target = nodes.find(n => n.id === e.target);
            });

            return { nodes, edges, references: Array.from(refs) };
        }

        function renderGraph(graphData) {
            data = graphData;
            g.selectAll("*").remove();

            const simulation = d3.forceSimulation(data.nodes)
                .force("link", d3.forceLink(data.edges).id(d => d.id).distance(120))
                .force("charge", d3.forceManyBody().strength(-300))
                .force("center", d3.forceCenter(width / 2, height / 2))
                .force("collision", d3.forceCollide().radius(40));

            const link = g.selectAll(".edge")
                .data(data.edges)
                .enter().append("line")
                .attr("class", "edge")
                .attr("stroke", d => d.agreement === "Yes" ? "#3498db" : d.agreement === "No" ? "#e74c3c" : "#bdc3c7")
                .on("mouseover", (e, d) => {
                    tooltip.transition().duration(200).style("opacity", .9);
                    tooltip.html(`<strong>Statement:</strong><br>${d.statement || 'N/A'}`)
                        .style("left", (e.pageX + 10) + "px").style("top", (e.pageY - 28) + "px");
                })
                .on("mouseout", () => tooltip.transition().duration(500).style("opacity", 0))
                .on("click", (e, d) => { e.stopPropagation(); displayEdgeDetails(d); });

            const node = g.selectAll(".node")
                .data(data.nodes)
                .enter().append("circle")
                .attr("class", "node")
                .attr("r", d => d.type === "Actor" ? 10 : 8)
                .attr("fill", d => d.type === "Actor" ? "#8e44ad" : "#27ae60")
                .on("click", (e, d) => { e.stopPropagation(); displayNodeStatements(d); })
                .call(d3.drag().on("start", dragstarted).on("drag", dragged).on("end", dragended));

            const label = g.selectAll(".label")
                .data(data.nodes)
                .enter().append("text")
                .attr("class", "label")
                .attr("dy", -15)
                .attr("text-anchor", "middle")
                .text(d => d.label);

            simulation.on("tick", () => {
                link.attr("x1", d => d.source.x).attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x).attr("y2", d => d.target.y);
                node.attr("cx", d => d.x).attr("cy", d => d.y);
                label.attr("x", d => d.x).attr("y", d => d.y);
            });

            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x; d.fy = d.y;
            }
            function dragged(event, d) { d.fx = event.x; d.fy = event.y; }
            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null; d.fy = null;
            }
        }

        function centerNode(node) {
            if (!node) return;
            const scale = 1.2;
            const x = -node.x * scale + width / 2;
            const y = -node.y * scale + height / 2;
            svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity.translate(x, y).scale(scale));
            
            const el = g.selectAll(".node").filter(d => d.id === node.id);
            const origColor = el.attr("fill");
            el.transition().duration(200).attr("fill", "yellow").transition().duration(200).attr("fill", origColor)
              .transition().duration(200).attr("fill", "yellow").transition().duration(200).attr("fill", origColor);
        }

        // --- Event Listeners ---

        d3.select("#file-input").on("change", (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                originalData = parseGML(event.target.result);
                d3.select("#actor-select").property("disabled", false);
                d3.select("#concept-select").property("disabled", false);
                d3.select("#search-input").property("disabled", false);
                d3.select("#search-button").property("disabled", false);
                d3.select("#save-csv-button").property("disabled", false);
                d3.select("#save-graph-button").property("disabled", false);
                
                // Populate Dropdowns
                const actors = originalData.nodes.filter(n => n.type === "Actor").sort((a,b) => a.label.localeCompare(b.label));
                const concepts = originalData.nodes.filter(n => n.type === "Concept").sort((a,b) => a.label.localeCompare(b.label));
                
                const actorSelect = d3.select("#actor-select");
                actors.forEach(a => actorSelect.append("option").attr("value", a.id).text(a.label));
                
                const conceptSelect = d3.select("#concept-select");
                concepts.forEach(c => conceptSelect.append("option").attr("value", c.id).text(c.label));

                renderGraph(originalData);
            };
            reader.readAsText(file);
        });

        d3.select("#actor-select").on("change", function() {
            const node = data.nodes.find(n => n.id === this.value);
            centerNode(node);
        });

        d3.select("#concept-select").on("change", function() {
            const node = data.nodes.find(n => n.id === this.value);
            centerNode(node);
        });

        d3.select("#citation-link").on("click", () => d3.select("#citation-popup").style("display", "block"));
        d3.select("#prompt-link").on("click", () => d3.select("#prompt-popup").style("display", "block"));

        function displayEdgeDetails(edge) {
            const content = d3.select("#edge-details-content");
            content.html(`
                <p><strong>Actor:</strong> ${edge.source.label}</p>
                <p><strong>Concept:</strong> ${edge.target.label}</p>
                <p><strong>Agreement:</strong> <span style="color:${edge.agreement === 'Yes' ? 'green' : 'red'}">${edge.agreement}</span></p>
                <p><strong>Statement:</strong><br><em>"${edge.statement}"</em></p>
                <p><strong>Reference:</strong> ${edge.reference || 'N/A'}</p>
            `);
            d3.select("#edge-details-popup").style("display", "block");
        }

        function displayNodeStatements(node) {
            d3.select("#node-title").text(`Statements: ${node.label}`);
            const results = d3.select("#node-statements-results").html("");
            const relatedEdges = data.edges.filter(e => e.source.id === node.id || e.target.id === node.id);
            
            relatedEdges.forEach(e => {
                results.append("div")
                    .style("border-bottom", "1px solid #eee")
                    .style("padding", "10px 0")
                    .html(`<strong>${e.source.label}</strong> ‚ûî <strong>${e.target.label}</strong><br><small>${e.statement}</small>`);
            });
            d3.select("#node-statements-popup").style("display", "block");
        }

        d3.select("#save-graph-button").on("click", () => {
            html2canvas(document.querySelector("#graph-container")).then(canvas => {
                const link = document.createElement('a');
                link.download = 'discourse_network_purnama.png';
                link.href = canvas.toDataURL();
                link.click();
            });
        });

        window.addEventListener('resize', () => {
            width = window.innerWidth - 300;
            height = window.innerHeight;
            svg.attr("width", width).attr("height", height);
        });

    </script>
</body>
</html>